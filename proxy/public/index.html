<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Telescope Player</title>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
      }

      video {
        width: 80%;
        border: 2px solid #222;
        border-radius: 8px;
      }

      #log {
        font-size: 14px;
        color: #444;
        margin-top: 1em;
      }
    </style>
  </head>

  <body>
    <h2>🚀 🌕 🔭 Telescope DASH Client</h2>

    <video id="videoPlayer" muted controls autoplay></video>

    <div id="log">Loading...</div>

    <script>
      const clientID = Math.random().toString(36).substring(2, 8);
      const mpdUrl = `/api/output`;

      const player = dashjs.MediaPlayer().create();
      const video = document.querySelector("#videoPlayer");
      player.initialize(video, mpdUrl, true);
      video.play();

      let xHeaders = {}; // Object to store X-headers from server responses

      player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
        document.getElementById('log').innerText = `Client ID: ${clientID}`;
      });

      player.on(dashjs.MediaPlayer.events.FRAGMENT_LOADING_STARTED, function (e) {
        console.log("Loading segment:", e.request.url);
      });

      player.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, function (e) {
        console.log("📜 Manifest event object:", e);
      });

      player.on(dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED, function (e) {
        console.log(`🎚️ Quality changed: type=${e.mediaType}, new index=${e.newQuality}`);
      });

      player.on(dashjs.MediaPlayer.events.BUFFER_LEVEL_UPDATED, (e) => {
        console.log(`📊 Buffer level: ${e.bufferLevel.toFixed(2)}s`);
      });

      // Extend RequestModifier to send additional headers
      player.extend("RequestModifier", () => ({
        modifyRequestHeader: function (xhr) {
          // Attach client ID to all outgoing requests
          xhr.setRequestHeader("X-Client-ID", clientID);

          // Attach captured X-headers to outgoing requests
          for (const [key, value] of Object.entries(xHeaders)) {
            xhr.setRequestHeader(key, value);
          }

          // Attach segment quality
          const qualityIndex = player.getQualityFor("video");
          xhr.setRequestHeader("X-Segment-Quality", qualityIndex);

          // Attach bandwidth
          const bandwidth = player.getAverageThroughput("video");
          xhr.setRequestHeader("X-Bandwidth", bandwidth);

          // Attach stall rate (buffer level)
          const bufferLevel = player.getBufferLength("video");
          xhr.setRequestHeader("X-Stall-Rate", bufferLevel);

          return xhr;
        },
        modifyRequestResponse: function (xhr) {
          // Capture X-headers from the server response
          const headers = xhr.getAllResponseHeaders().split("\r\n");
          headers.forEach(header => {
            const [key, value] = header.split(": ");
            if (key && key.startsWith("X-Server-")) {
              xHeaders[key] = value;
            }
          });

          return xhr.response;
        }
      }), true);
    </script>
  </body>
</html>
