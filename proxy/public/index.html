<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Telescope Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dashjs/4.4.1/dash.all.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        padding: 2em;
      }

      video {
        width: 80%;
        border: 2px solid #222;
        border-radius: 8px;
      }

      #log {
        font-size: 14px;
        color: #444;
        margin-top: 1em;
      }
    </style>
  </head>

  <body>
    <h2>🚀 🌕 🔭 Telescope DASH Client</h2>

    <video id="videoPlayer" muted controls autoplay></video>

    <div id="log">Loading...</div>

    <script>
      const clientID = Math.random().toString(36).substring(2, 8);
      const mpdUrl = `/api/output`;

      const player = dashjs.MediaPlayer().create();
      const video = document.querySelector("#videoPlayer");

      let stallStartTime = 0;
      let totalStallTime = 0;

      // Track stall time
      player.on(dashjs.MediaPlayer.events.BUFFER_EMPTY, () => {
        console.log("BUFFER_EMPTY event triggered");
        stallStartTime = performance.now();
      });

      player.on(dashjs.MediaPlayer.events.BUFFER_LOADED, () => {
        console.log("BUFFER_LOADED event triggered");
        if (stallStartTime > 0) {
          const stallDuration = performance.now() - stallStartTime;
          totalStallTime += stallDuration;
          console.log(
            `Stall duration added: ${stallDuration}ms, Total stall time: ${totalStallTime}ms`
          );
          stallStartTime = 0;
        }
      });

      // event listeners
      player.on(dashjs.MediaPlayer.events.STREAM_INITIALIZED, () => {
        document.getElementById("log").innerText = `Client ID: ${clientID}`;
      });
      player.on(
        dashjs.MediaPlayer.events.FRAGMENT_LOADING_STARTED,
        function (e) {
          console.log("Loading segment:", e.request.url);
          console.log("Response:", e);
        }
      );
      player.on(dashjs.MediaPlayer.events.MANIFEST_LOADED, function (e) {
        console.log("📜 Manifest event object:", e);
      });
      player.on(
        dashjs.MediaPlayer.events.QUALITY_CHANGE_RENDERED,
        function (e) {
          console.log(
            `🎚️ Quality changed: type=${e.mediaType}, new index=${e.newQuality}`
          );
        }
      );
      player.on(dashjs.MediaPlayer.events.BUFFER_LEVEL_UPDATED, (e) => {
        console.log(`📊 Buffer level: ${e.bufferLevel.toFixed(2)}s`);
      });

      // Extend RequestModifier to send additional headers
      player.extend(
        "RequestModifier",
        function () {
          return {
            modifyRequestHeader: function (xhr) {
              xhr.setRequestHeader("X-Client-ID", clientID);

              // Add bandwidth, stall rate, and video quality
              const bandwidth = player.getAverageThroughput("video");
              const totalVideoTime = video.duration || 1; // Avoid division by zero
              const stallRate = totalStallTime / totalVideoTime; // Convert ms to seconds

              const qualityIndex = player.getQualityFor("video");

              xhr.setRequestHeader("X-Bandwidth", bandwidth);
              xhr.setRequestHeader("X-Stall-Rate", stallRate.toFixed(10));
              xhr.setRequestHeader("X-Segment-Quality", qualityIndex);

              // Attach captured X-headers to outgoing requests
              for (const [key, value] of Object.entries(xHeaders)) {
                xhr.setRequestHeader(key, value);
              }

              return xhr;
            },
          };
        },
        true
      );

      player.initialize(video, mpdUrl, true);
      video.play();
    </script>
  </body>
</html>
